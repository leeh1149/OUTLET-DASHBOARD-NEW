<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DX OUTLET 매출 대시보드</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .filters {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-weight: bold;
            color: #555;
        }

        .filter-group select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            min-width: 200px;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .metric-label {
            color: #666;
            font-size: 0.9em;
        }

        .section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .group-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .group-header h1 {
            font-size: 1.8em;
            margin: 0;
        }

        .group-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .tab-navigation {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .tab-button {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
            color: #666;
            border: 2px solid transparent;
        }

        .tab-button:hover {
            background: #e9ecef;
            color: #333;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: 2px solid #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .chart-container {
            margin: 20px 0;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #333;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group select {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🏪 DX OUTLET 매출 대시보드</h1>
        <p>실시간 데이터 분석 및 시각화</p>
    </div>

    <div class="container">
        <!-- 데이터 로드 섹션 -->
        <div class="section">
            <h2>📁 데이터 로드</h2>
            <div style="text-align: center; padding: 20px;">
                <button id="loadDataBtn" style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: none;
                    padding: 15px 30px;
                    font-size: 16px;
                    border-radius: 25px;
                    cursor: pointer;
                    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
                    transition: transform 0.2s;
                " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    📊 데이터 자동 로드
                </button>
                <p style="margin-top: 10px; color: #666; font-size: 14px;">
                    AI_STUDY 폴더의 DX OUTLET MS DB.csv 파일을 자동으로 로드합니다
                </p>
                <p id="loadStatus" style="margin-top: 10px; font-size: 14px; font-weight: bold;">
                    🔄 데이터 로드를 시작하려면 버튼을 클릭하세요
                </p>
            </div>
        </div>

        <!-- 필터 섹션 -->
        <div class="filters" id="filtersSection" style="display: none;">
            <div class="filter-group">
                <label for="distributor">유통사 선택</label>
                <select id="distributor">
                    <option value="전체">전체</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="store">매장명 선택</label>
                <select id="store">
                    <option value="전체">전체</option>
                </select>
            </div>
        </div>

        <!-- 메트릭 카드 -->
        <div class="metrics" id="metricsSection" style="display: none;">
            <div class="metric-card">
                <div class="metric-value" id="selectedDistributor">전체</div>
                <div class="metric-label">선택된 유통사</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="selectedStore">전체</div>
                <div class="metric-label">선택된 매장</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="dataCount">0</div>
                <div class="metric-label">데이터 건수</div>
            </div>
        </div>

        <!-- 탭 네비게이션 -->
        <div class="tab-navigation">
            <button class="tab-button active" onclick="showPage('outletTrendsPage')">
                🏪 아울렛 동향
            </button>
            <button class="tab-button" onclick="showPage('storeEfficiencyPage')">
                📊 매장 효율
            </button>
        </div>

        <!-- 아울렛 동향 페이지 -->
        <div class="page active" id="outletTrendsPage">
            <div class="group" id="outletTrendsGroup">
            <div class="group-header">
                <h1>🏪 아울렛 동향</h1>
            </div>
            <div class="group-content">
        <!-- 아울렛 매출 흐름 -->
                <div class="section" id="outletSection">
                    <h2>📈 아울렛 매출 흐름 - 디스커버리</h2>
            
            <!-- 유통사별 총매출 및 평균매출 표 -->
            <div class="table-container" style="margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: #333; margin: 0;">유통사별 디스커버리 총매출 및 평균매출</h3>
                    <div style="display: flex; gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="seasonType" value="SS" checked style="margin: 0;">
                            <span>SS 시즌</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="seasonType" value="FW" style="margin: 0;">
                            <span>FW 시즌</span>
                        </label>
                    </div>
                </div>
                <table id="summaryTable">
                    <thead id="summaryTableHead">
                        <tr>
                            <th>유통사</th>
                            <th>매장수</th>
                            <th>25SS 총매출</th>
                            <th>25SS 총매출(구성비)</th>
                            <th>24SS 총매출</th>
                            <th>24SS 총매출(구성비)</th>
                            <th>SS 총매출 전년비</th>
                            <th>25SS 평균매출</th>
                            <th>25SS 평균매출(구성비)</th>
                            <th>24SS 평균매출</th>
                            <th>24SS 평균매출(구성비)</th>
                            <th>SS 평균매출 전년비</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <!-- 시즌별 매출 흐름 차트 -->
            <!-- SS 시즌 매출 비교 차트 -->
            <div class="chart-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: #333; margin: 0;">유통사별 디스커버리 SS 시즌 매출 비교</h3>
                    <div style="display: flex; gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="ssChartDataType" value="total" checked style="margin: 0;">
                            <span>총 매출</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="ssChartDataType" value="average" style="margin: 0;">
                            <span>평균 매출</span>
                        </label>
                    </div>
                </div>
                <div id="ssSeasonalFlowChart"></div>
            </div>
            
            <!-- FW 시즌 매출 비교 차트 -->
            <div class="chart-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: #333; margin: 0;">유통사별 디스커버리 FW 시즌 매출 비교</h3>
                    <div style="display: flex; gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="fwChartDataType" value="total" checked style="margin: 0;">
                            <span>총 매출</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="fwChartDataType" value="average" style="margin: 0;">
                            <span>평균 매출</span>
                        </label>
                    </div>
                </div>
                <div id="fwSeasonalFlowChart"></div>
            </div>
            
            <!-- 상세 시즌별 매출 표 -->
            <div class="table-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: #333; margin: 0;">유통사별 디스커버리 시즌별 상세 매출</h3>
                    <div style="display: flex; gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="distributorDataType" value="total" checked style="margin: 0;">
                            <span>총 매출</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="distributorDataType" value="average" style="margin: 0;">
                            <span>평균 매출</span>
                        </label>
                    </div>
                </div>
                <table id="distributorTable">
                    <thead id="distributorTableHead">
                        <tr>
                            <th>유통사</th>
                            <th>매장수</th>
                            <th>25SS</th>
                            <th>24SS</th>
                            <th>SS 전년비</th>
                            <th>24FW</th>
                            <th>23FW</th>
                            <th>FW 전년비</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- 동업계 MS 현황 -->
                <div class="section" id="msSection">
            <h2>🏢 동업계 MS 현황</h2>
            
            <!-- 시즌 선택 -->
            <div style="display: flex; justify-content: center; margin-bottom: 20px;">
                <div style="display: flex; gap: 20px; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <label style="display: flex; align-items: center; gap: 8px; font-weight: bold; cursor: pointer;">
                        <input type="radio" name="msSeasonType" value="SS" checked style="margin: 0; transform: scale(1.2);">
                        <span>SS 시즌</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; font-weight: bold; cursor: pointer;">
                        <input type="radio" name="msSeasonType" value="FW" style="margin: 0; transform: scale(1.2);">
                        <span>FW 시즌</span>
                    </label>
                </div>
            </div>
            
            <!-- 선택된 시즌 차트 컨테이너 -->
            <div class="chart-container">
                <h3 id="msChartTitle" style="color: #333; margin-bottom: 15px;">SS 시즌 매출 현황</h3>
                <div id="msSelectedChart"></div>
            </div>
            
            <!-- MS 현황 표 -->
            <div class="table-container">
                <h3 style="color: #333; margin-bottom: 15px;">브랜드별 매출 순위</h3>
                <table id="msTable">
                    <thead>
                        <tr id="msTableHead">
                            <th>순위</th>
                            <th>브랜드</th>
                            <th>25SS</th>
                            <th>24SS</th>
                            <th>SS 전년비</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
                </div>
                </div>
            </div>

        <!-- 매장 효율 페이지 -->
        <div class="page" id="storeEfficiencyPage">
            <div class="group" id="storeEfficiencyGroup">
                <div class="group-header">
                    <h1>📊 매장 효율</h1>
                </div>
                <div class="group-content">
                    <!-- 매장 효율 분석 섹션 -->
                    <div class="section">
                        <h2>🚀 디스커버리 매장 효율 분석</h2>
                        <p style="color: #666; margin-bottom: 20px;">
                            디스커버리 브랜드 매장별 평수 대비 시즌별 매출액 효율성을 분석합니다. (평당 매출액 기준)
                        </p>
                        
                        <!-- 효율성 순위 표 -->
                        <div class="chart-container">
                            <h3 style="color: #333; margin-bottom: 15px;">디스커버리 매장별 평균 효율성 순위 (평당 매출액 기준)</h3>
                            <div id="efficiencyRankingTable"></div>
                        </div>
                        
                        <!-- 시즌별 효율성 히트맵 -->
                        <div class="chart-container">
                            <h3 style="color: #333; margin-bottom: 15px;">디스커버리 매장 시즌별 효율성 히트맵</h3>
                            <div id="efficiencyHeatmapChart"></div>
                        </div>
                        
                        <!-- 매장면적 vs 효율성 산점도 -->
                        <div class="chart-container">
                            <h3 style="color: #333; margin-bottom: 15px;">디스커버리 매장면적 vs 평균효율성</h3>
                            <div id="areaVsEfficiencyChart"></div>
                        </div>
                        
                        <!-- 시즌별 매출액 트렌드 -->
                        <div class="chart-container">
                            <h3 style="color: #333; margin-bottom: 15px;">디스커버리 상위 매장의 시즌별 매출액 트렌드</h3>
                            <div id="seasonalTrendChart"></div>
                        </div>
                        
                        <!-- 선택된 매장 상세 정보 -->
                        <div class="section" id="selectedStoreDetails" style="display: none;">
                            <h2>🏪 선택된 매장 상세 정보</h2>
                            <div id="storeDetailsContent"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        let rawData = [];
        let filteredData = [];

        // 억원 단위 변환 함수
        function formatToHundredMillion(value) {
            const hundredMillion = value / 100000000; // 억원 단위로 변환
            return hundredMillion.toFixed(1) + '억원';
        }

        // CSV 파일 자동 로드
        function loadData() {
            // CSV 파일을 직접 fetch로 로드
            fetch('DX OUTLET MS DB.csv')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('CSV 파일을 찾을 수 없습니다.');
                    }
                    return response.text();
                })
                .then(csvText => {
                    Papa.parse(csvText, {
                        header: true,
                        complete: function(results) {
                            rawData = results.data;
                            filteredData = [...rawData];
                            initializeDashboard();
                            
                            // 로드 성공 메시지 표시
                            updateLoadStatus('✅ 데이터 로드 완료', 'success');
                        },
                        error: function(error) {
                            console.error('CSV 파싱 에러:', error);
                            showError('데이터를 파싱하는 중 오류가 발생했습니다.');
                            updateLoadStatus('❌ 데이터 파싱 오류', 'error');
                        }
                    });
                })
                .catch(error => {
                    console.error('CSV 파일 로드 에러:', error);
                    showError('CSV 파일을 로드하는 중 오류가 발생했습니다: ' + error.message);
                    updateLoadStatus('❌ 파일 로드 오류', 'error');
                });
        }
        
        // 로드 상태 업데이트
        function updateLoadStatus(message, type) {
            const statusElement = document.getElementById('loadStatus');
            if (statusElement) {
                statusElement.textContent = message;
                if (type === 'success') {
                    statusElement.style.color = '#28a745';
                } else if (type === 'error') {
                    statusElement.style.color = '#dc3545';
                } else if (type === 'loading') {
                    statusElement.style.color = '#007bff';
                }
            }
        }

        function showError(message) {
            const container = document.querySelector('.container');
            container.innerHTML = `
                <div class="error">
                    <h3>오류 발생</h3>
                    <p>${message}</p>
                </div>
            `;
        }

        function initializeDashboard() {
            // 섹션들 표시
            document.getElementById('filtersSection').style.display = 'flex';
            document.getElementById('metricsSection').style.display = 'grid';
            
            setupFilters();
            updateMetrics();
            updateCharts();
            updateTables();
        }

        function setupFilters() {
            const distributorSelect = document.getElementById('distributor');
            const storeSelect = document.getElementById('store');

            // 유통사 목록 생성
            const distributors = [...new Set(rawData.map(row => row['유통사']))].filter(Boolean);
            distributors.forEach(distributor => {
                const option = document.createElement('option');
                option.value = distributor;
                option.textContent = distributor;
                distributorSelect.appendChild(option);
            });

            // 매장명 목록 생성
            const stores = [...new Set(rawData.map(row => row['매장명']))].filter(Boolean);
            stores.forEach(store => {
                const option = document.createElement('option');
                option.value = store;
                option.textContent = store;
                storeSelect.appendChild(option);
            });

            // 이벤트 리스너 추가
            distributorSelect.addEventListener('change', function() {
                updateStoreOptions();
                filterData();
            });

            storeSelect.addEventListener('change', function() {
                filterData();
            });
        }

        function updateStoreOptions() {
            const distributorSelect = document.getElementById('distributor');
            const storeSelect = document.getElementById('store');
            const selectedDistributor = distributorSelect.value;

            // 매장명 옵션 초기화
            storeSelect.innerHTML = '<option value="전체">전체</option>';

            if (selectedDistributor !== '전체') {
                const stores = [...new Set(
                    rawData
                        .filter(row => row['유통사'] === selectedDistributor)
                        .map(row => row['매장명'])
                )].filter(Boolean);

                stores.forEach(store => {
                    const option = document.createElement('option');
                    option.value = store;
                    option.textContent = store;
                    storeSelect.appendChild(option);
                });
            }
        }

        function filterData() {
            const distributorSelect = document.getElementById('distributor');
            const storeSelect = document.getElementById('store');
            const selectedDistributor = distributorSelect.value;
            const selectedStore = storeSelect.value;

            filteredData = rawData.filter(row => {
                const distributorMatch = selectedDistributor === '전체' || row['유통사'] === selectedDistributor;
                const storeMatch = selectedStore === '전체' || row['매장명'] === selectedStore;
                return distributorMatch && storeMatch;
            });

            updateMetrics();
            // 아울렛 매출 흐름은 필터와 무관하게 고정이므로 제외
            updateMSCharts();
        }

        function updateMetrics() {
            document.getElementById('selectedDistributor').textContent = 
                document.getElementById('distributor').value;
            document.getElementById('selectedStore').textContent = 
                document.getElementById('store').value;
            document.getElementById('dataCount').textContent = filteredData.length;
        }

        function updateCharts() {
            // 아울렛 매출 흐름은 디스커버리 브랜드만 표시
            updateDistributorCharts();
            updateMSCharts();
        }

        function updateDistributorCharts() {
            // 아울렛 매출 흐름은 디스커버리 브랜드만 표시
            const distributorData = {};
            const discoveryData = rawData.filter(row => row['브랜드'] === '디스커버리');
            const distributors = [...new Set(discoveryData.map(row => row['유통사']))].filter(Boolean);

            distributors.forEach(distributor => {
                const distributorRows = discoveryData.filter(row => row['유통사'] === distributor);
                const seasonColumns = ['23SS', '23FW', '24SS', '24FW', '25SS'];
                
                const seasonTotals = seasonColumns.map(season => 
                    distributorRows.reduce((sum, row) => sum + (parseInt(row[season]) || 0), 0)
                );
                
                const totalSales = seasonTotals.reduce((sum, val) => sum + val, 0);
                const avgSales = totalSales / seasonColumns.length;

                // 매장 수 계산
                const storeCount = [...new Set(distributorRows.map(row => row['매장명']))].length;

                // SS 시즌 데이터
                const ss2025 = seasonTotals[4]; // 25SS
                const ss2024 = seasonTotals[2]; // 24SS
                const avgSS2025 = ss2025 / storeCount;
                const avgSS2024 = ss2024 / storeCount;

                // FW 시즌 데이터
                const fw2024 = seasonTotals[3]; // 24FW
                const fw2023 = seasonTotals[1]; // 23FW
                const avgFW2024 = fw2024 / storeCount;
                const avgFW2023 = fw2023 / storeCount;

                distributorData[distributor] = {
                    totalSales,
                    avgSales,
                    seasonTotals,
                    storeCount,
                    ss2025,
                    ss2024,
                    avgSS2025,
                    avgSS2024,
                    fw2024,
                    fw2023,
                    avgFW2024,
                    avgFW2023
                };
            });

            // 요약 테이블 업데이트
            updateSummaryTable(distributorData);

            // 시즌별 매출 흐름 차트
            const seasons = ['23SS', '23FW', '24SS', '24FW', '25SS'];
            const seasonLabels = ['2023 SS', '2023 FW', '2024 SS', '2024 FW', '2025 SS'];
            
            // SS 차트 데이터 구성
            const selectedSSDataType = document.querySelector('input[name="ssChartDataType"]:checked').value;
            
            let ssData;
            let ssChartTitle;
            
            if (selectedSSDataType === 'total') {
                ssData = [{
                    x: distributors,
                    y: distributors.map(distributor => distributorData[distributor].ss2025 / 100000000),
                    type: 'bar',
                    name: '25SS',
                    marker: { color: '#1f77b4' }
                }, {
                    x: distributors,
                    y: distributors.map(distributor => distributorData[distributor].ss2024 / 100000000),
                    type: 'bar',
                    name: '24SS',
                    marker: { color: '#ff7f0e' }
                }];
                ssChartTitle = '유통사별 디스커버리 SS 시즌 총 매출 비교';
            } else {
                ssData = [{
                    x: distributors,
                    y: distributors.map(distributor => distributorData[distributor].avgSS2025 / 100000000),
                    type: 'bar',
                    name: '25SS 평균',
                    marker: { color: '#1f77b4' }
                }, {
                    x: distributors,
                    y: distributors.map(distributor => distributorData[distributor].avgSS2024 / 100000000),
                    type: 'bar',
                    name: '24SS 평균',
                    marker: { color: '#ff7f0e' }
                }];
                ssChartTitle = '유통사별 디스커버리 SS 시즌 평균 매출 비교';
            }

            Plotly.newPlot('ssSeasonalFlowChart', ssData, {
                title: ssChartTitle,
                xaxis: { title: '유통사' },
                yaxis: { title: selectedSSDataType === 'total' ? '총 매출 (억원)' : '평균 매출 (억원)' },
                barmode: 'group'
            });

            // FW 차트 데이터 구성
            const selectedFWDataType = document.querySelector('input[name="fwChartDataType"]:checked').value;
            
            let fwData;
            let fwChartTitle;
            
            if (selectedFWDataType === 'total') {
                fwData = [{
                    x: distributors,
                    y: distributors.map(distributor => distributorData[distributor].fw2024 / 100000000),
                    type: 'bar',
                    name: '24FW',
                    marker: { color: '#2ca02c' }
                }, {
                    x: distributors,
                    y: distributors.map(distributor => distributorData[distributor].fw2023 / 100000000),
                    type: 'bar',
                    name: '23FW',
                    marker: { color: '#d62728' }
                }];
                fwChartTitle = '유통사별 디스커버리 FW 시즌 총 매출 비교';
            } else {
                fwData = [{
                    x: distributors,
                    y: distributors.map(distributor => distributorData[distributor].avgFW2024 / 100000000),
                    type: 'bar',
                    name: '24FW 평균',
                    marker: { color: '#2ca02c' }
                }, {
                    x: distributors,
                    y: distributors.map(distributor => distributorData[distributor].avgFW2023 / 100000000),
                    type: 'bar',
                    name: '23FW 평균',
                    marker: { color: '#d62728' }
                }];
                fwChartTitle = '유통사별 디스커버리 FW 시즌 평균 매출 비교';
            }

            Plotly.newPlot('fwSeasonalFlowChart', fwData, {
                title: fwChartTitle,
                xaxis: { title: '유통사' },
                yaxis: { title: selectedFWDataType === 'total' ? '총 매출 (억원)' : '평균 매출 (억원)' },
                barmode: 'group'
            });
        }

        function updateMSCharts() {
            // 브랜드별 데이터 집계
            const brands = [...new Set(filteredData.map(row => row['브랜드']))].filter(Boolean);
            const msData = {};

            brands.forEach(brand => {
                const brandRows = filteredData.filter(row => row['브랜드'] === brand);
                
                const ss2025 = brandRows.reduce((sum, row) => sum + (parseInt(row['25SS']) || 0), 0);
                const ss2024 = brandRows.reduce((sum, row) => sum + (parseInt(row['24SS']) || 0), 0);
                const fw2024 = brandRows.reduce((sum, row) => sum + (parseInt(row['24FW']) || 0), 0);
                const fw2023 = brandRows.reduce((sum, row) => sum + (parseInt(row['23FW']) || 0), 0);
                
                const ssGrowth = ss2024 !== 0 ? ((ss2025 - ss2024) / ss2024 * 100) : 0;
                const fwGrowth = fw2023 !== 0 ? ((fw2024 - fw2023) / fw2023 * 100) : 0;

                msData[brand] = {
                    ss2025, ss2024, fw2024, fw2023, ssGrowth, fwGrowth
                };
            });

            // 선택된 시즌에 따라 차트 업데이트
            updateMSSelectedChart(msData);
            updateMSTable(msData);
        }

        function updateMSSelectedChart(msData) {
            const selectedSeason = document.querySelector('input[name="msSeasonType"]:checked').value;
            
            if (selectedSeason === 'SS') {
            // SS 시즌 데이터를 매출 순으로 정렬
            const ssSortedData = Object.entries(msData)
                .sort(([,a], [,b]) => b.ss2025 - a.ss2025);
            
            const ssBrands = ssSortedData.map(([brand]) => brand);
            const ss2025Values = ssSortedData.map(([,data]) => data.ss2025);
            const ss2024Values = ssSortedData.map(([,data]) => data.ss2024);
            
            // SS 총 매출 계산 (구성비용)
            const ssTotal = ss2025Values.reduce((sum, val) => sum + val, 0);
            
            const ssData = [{
                x: ssBrands,
                y: ss2025Values,
                type: 'bar',
                name: '25SS',
                marker: { 
                    color: ssBrands.map(brand => brand === '디스커버리' ? '#FF6B35' : '#1f77b4'),
                    line: { 
                        color: ssBrands.map(brand => brand === '디스커버리' ? '#FF4500' : '#1f77b4'),
                        width: ssBrands.map(brand => brand === '디스커버리' ? 3 : 1)
                    }
                },
                text: ss2025Values.map(val => `${val.toLocaleString()}<br><span style="font-size: 0.8em;">(${((val/ssTotal)*100).toFixed(1)}%)</span>`),
                textposition: 'outside',
                hovertemplate: '<b>%{x}</b><br>25SS: %{y:,.0f}<br>구성비: %{customdata:.1f}%<extra></extra>',
                customdata: ss2025Values.map(val => (val/ssTotal)*100)
            }, {
                x: ssBrands,
                y: ss2024Values,
                type: 'bar',
                name: '24SS',
                marker: { 
                    color: ssBrands.map(brand => brand === '디스커버리' ? '#FF8C42' : '#ff7f0e'),
                    line: { 
                        color: ssBrands.map(brand => brand === '디스커버리' ? '#FF4500' : '#ff7f0e'),
                        width: ssBrands.map(brand => brand === '디스커버리' ? 3 : 1)
                    }
                },
                text: ss2024Values.map(val => `${val.toLocaleString()}<br><span style="font-size: 0.8em;">(${((val/ssTotal)*100).toFixed(1)}%)</span>`),
                textposition: 'outside',
                hovertemplate: '<b>%{x}</b><br>24SS: %{y:,.0f}<br>구성비: %{customdata:.1f}%<extra></extra>',
                customdata: ss2024Values.map(val => (val/ssTotal)*100)
            }];

                Plotly.newPlot('msSelectedChart', ssData, {
                title: 'SS 시즌 매출 현황 (높은 매출 순)',
                xaxis: { title: '브랜드' },
                yaxis: { title: '매출 (억원)' },
                barmode: 'group'
            });

                document.getElementById('msChartTitle').textContent = 'SS 시즌 매출 현황';
            } else {
                // FW 시즌 데이터를 매출 순으로 정렬
                const fwSortedData = Object.entries(msData)
                    .sort(([,a], [,b]) => b.fw2024 - a.fw2024);
                
            const fwBrands = fwSortedData.map(([brand]) => brand);
            const fw2024Values = fwSortedData.map(([,data]) => data.fw2024);
            const fw2023Values = fwSortedData.map(([,data]) => data.fw2023);
            
            // FW 총 매출 계산 (구성비용)
            const fwTotal = fw2024Values.reduce((sum, val) => sum + val, 0);
            
            const fwData = [{
                x: fwBrands,
                y: fw2024Values,
                type: 'bar',
                name: '24FW',
                marker: { 
                    color: fwBrands.map(brand => brand === '디스커버리' ? '#FF6B35' : '#2ca02c'),
                    line: { 
                        color: fwBrands.map(brand => brand === '디스커버리' ? '#FF4500' : '#2ca02c'),
                        width: fwBrands.map(brand => brand === '디스커버리' ? 3 : 1)
                    }
                },
                text: fw2024Values.map(val => `${val.toLocaleString()}<br><span style="font-size: 0.8em;">(${((val/fwTotal)*100).toFixed(1)}%)</span>`),
                textposition: 'outside',
                hovertemplate: '<b>%{x}</b><br>24FW: %{y:,.0f}<br>구성비: %{customdata:.1f}%<extra></extra>',
                customdata: fw2024Values.map(val => (val/fwTotal)*100)
            }, {
                x: fwBrands,
                y: fw2023Values,
                type: 'bar',
                name: '23FW',
                marker: { 
                    color: fwBrands.map(brand => brand === '디스커버리' ? '#FF8C42' : '#d62728'),
                    line: { 
                        color: fwBrands.map(brand => brand === '디스커버리' ? '#FF4500' : '#d62728'),
                        width: fwBrands.map(brand => brand === '디스커버리' ? 3 : 1)
                    }
                },
                text: fw2023Values.map(val => `${val.toLocaleString()}<br><span style="font-size: 0.8em;">(${((val/fwTotal)*100).toFixed(1)}%)</span>`),
                textposition: 'outside',
                hovertemplate: '<b>%{x}</b><br>23FW: %{y:,.0f}<br>구성비: %{customdata:.1f}%<extra></extra>',
                customdata: fw2023Values.map(val => (val/fwTotal)*100)
            }];

                Plotly.newPlot('msSelectedChart', fwData, {
                title: 'FW 시즌 매출 현황 (높은 매출 순)',
                xaxis: { title: '브랜드' },
                yaxis: { title: '매출 (억원)' },
                barmode: 'group'
            });

                document.getElementById('msChartTitle').textContent = 'FW 시즌 매출 현황';
            }
        }

        function updateMSTable(msData) {
            const selectedSeason = document.querySelector('input[name="msSeasonType"]:checked').value;
            const tbody = document.querySelector('#msTable tbody');
            const thead = document.querySelector('#msTableHead');
            tbody.innerHTML = '';

            if (selectedSeason === 'SS') {
                // SS 시즌 데이터를 매출 순으로 정렬
                const ssSortedData = Object.entries(msData)
                    .sort(([,a], [,b]) => b.ss2025 - a.ss2025);
                
                // 총합 계산
                const totalSS2025 = ssSortedData.reduce((sum, [,data]) => sum + data.ss2025, 0);
                const totalSS2024 = ssSortedData.reduce((sum, [,data]) => sum + data.ss2024, 0);
                const totalGrowth = totalSS2024 !== 0 ? ((totalSS2025 - totalSS2024) / totalSS2024 * 100) : 0;
                
                // 헤더 업데이트
                thead.innerHTML = `
                    <th>순위</th>
                    <th>브랜드</th>
                    <th>25SS</th>
                    <th>24SS</th>
                    <th>SS 전년비</th>
                `;

                // 테이블 데이터 추가
                ssSortedData.forEach(([brand, data], index) => {
                    const row = tbody.insertRow();
                    const rank = index + 1;
                    
                    // 디스커버리 강조 스타일
                    if (brand === '디스커버리') {
                        row.style.backgroundColor = '#FFF5F0';
                        row.style.fontWeight = 'bold';
                        row.style.border = '2px solid #FF6B35';
                    }
                    
                    row.insertCell(0).innerHTML = `<span style="font-weight: bold; color: ${rank <= 3 ? '#FF6B35' : '#333'}; font-size: 1.1em;">${rank}</span>`;
                    
                    // 브랜드명
                    const brandCell = row.insertCell(1);
                    brandCell.textContent = brand;
                    if (brand === '디스커버리') {
                        brandCell.style.color = '#FF6B35';
                        brandCell.style.fontWeight = 'bold';
                    }
                    
                    // 25SS (구성비 포함)
                    const ss2025Cell = row.insertCell(2);
                    const ss2025Composition = ((data.ss2025 / totalSS2025) * 100).toFixed(1);
                    ss2025Cell.innerHTML = `${formatToHundredMillion(data.ss2025)}<br><span style="font-size: 0.8em; color: #666;">(${ss2025Composition}%)</span>`;
                    
                    // 24SS (구성비 포함)
                    const ss2024Cell = row.insertCell(3);
                    const ss2024Composition = ((data.ss2024 / totalSS2024) * 100).toFixed(1);
                    ss2024Cell.innerHTML = `${formatToHundredMillion(data.ss2024)}<br><span style="font-size: 0.8em; color: #666;">(${ss2024Composition}%)</span>`;
                    
                    const growthCell = row.insertCell(4);
                    const growthText = data.ssGrowth >= 0 ? `+${data.ssGrowth.toFixed(1)}%` : `${data.ssGrowth.toFixed(1)}%`;
                    growthCell.innerHTML = `<span style="color: ${data.ssGrowth >= 0 ? '#0066cc' : '#cc0000'}; font-weight: bold;">${growthText}</span>`;
                });

                // 합계 행 추가
                const totalRow = tbody.insertRow();
                totalRow.style.backgroundColor = '#f8f9fa';
                totalRow.style.fontWeight = 'bold';
                totalRow.style.borderTop = '3px solid #333';
                
                totalRow.insertCell(0).innerHTML = '<span style="color: #333; font-size: 1.1em;">합계</span>';
                totalRow.insertCell(1).textContent = '전체';
                totalRow.insertCell(2).innerHTML = `${formatToHundredMillion(totalSS2025)}<br><span style="font-size: 0.8em; color: #666;">(100.0%)</span>`;
                totalRow.insertCell(3).innerHTML = `${formatToHundredMillion(totalSS2024)}<br><span style="font-size: 0.8em; color: #666;">(100.0%)</span>`;
                
                const totalGrowthCell = totalRow.insertCell(4);
                const totalGrowthText = totalGrowth >= 0 ? `+${totalGrowth.toFixed(1)}%` : `${totalGrowth.toFixed(1)}%`;
                totalGrowthCell.innerHTML = `<span style="color: ${totalGrowth >= 0 ? '#0066cc' : '#cc0000'}; font-weight: bold; font-size: 1.1em;">${totalGrowthText}</span>`;
                
            } else {
                // FW 시즌 데이터를 매출 순으로 정렬
                const fwSortedData = Object.entries(msData)
                    .sort(([,a], [,b]) => b.fw2024 - a.fw2024);
                
                // 총합 계산
                const totalFW2024 = fwSortedData.reduce((sum, [,data]) => sum + data.fw2024, 0);
                const totalFW2023 = fwSortedData.reduce((sum, [,data]) => sum + data.fw2023, 0);
                const totalGrowth = totalFW2023 !== 0 ? ((totalFW2024 - totalFW2023) / totalFW2023 * 100) : 0;
                
                // 헤더 업데이트
                thead.innerHTML = `
                    <th>순위</th>
                    <th>브랜드</th>
                    <th>24FW</th>
                    <th>23FW</th>
                    <th>FW 전년비</th>
                `;

                // 테이블 데이터 추가
                fwSortedData.forEach(([brand, data], index) => {
                    const row = tbody.insertRow();
                    const rank = index + 1;
                    
                    // 디스커버리 강조 스타일
                    if (brand === '디스커버리') {
                        row.style.backgroundColor = '#FFF5F0';
                        row.style.fontWeight = 'bold';
                        row.style.border = '2px solid #FF6B35';
                    }
                    
                    row.insertCell(0).innerHTML = `<span style="font-weight: bold; color: ${rank <= 3 ? '#FF6B35' : '#333'}; font-size: 1.1em;">${rank}</span>`;
                    
                    // 브랜드명
                    const brandCell = row.insertCell(1);
                    brandCell.textContent = brand;
                    if (brand === '디스커버리') {
                        brandCell.style.color = '#FF6B35';
                        brandCell.style.fontWeight = 'bold';
                    }
                    
                    // 24FW (구성비 포함)
                    const fw2024Cell = row.insertCell(2);
                    const fw2024Composition = ((data.fw2024 / totalFW2024) * 100).toFixed(1);
                    fw2024Cell.innerHTML = `${formatToHundredMillion(data.fw2024)}<br><span style="font-size: 0.8em; color: #666;">(${fw2024Composition}%)</span>`;
                    
                    // 23FW (구성비 포함)
                    const fw2023Cell = row.insertCell(3);
                    const fw2023Composition = ((data.fw2023 / totalFW2023) * 100).toFixed(1);
                    fw2023Cell.innerHTML = `${formatToHundredMillion(data.fw2023)}<br><span style="font-size: 0.8em; color: #666;">(${fw2023Composition}%)</span>`;
                    
                    const growthCell = row.insertCell(4);
                    const growthText = data.fwGrowth >= 0 ? `+${data.fwGrowth.toFixed(1)}%` : `${data.fwGrowth.toFixed(1)}%`;
                    growthCell.innerHTML = `<span style="color: ${data.fwGrowth >= 0 ? '#0066cc' : '#cc0000'}; font-weight: bold;">${growthText}</span>`;
                });

                // 합계 행 추가
                const totalRow = tbody.insertRow();
                totalRow.style.backgroundColor = '#f8f9fa';
                totalRow.style.fontWeight = 'bold';
                totalRow.style.borderTop = '3px solid #333';
                
                totalRow.insertCell(0).innerHTML = '<span style="color: #333; font-size: 1.1em;">합계</span>';
                totalRow.insertCell(1).textContent = '전체';
                totalRow.insertCell(2).innerHTML = `${formatToHundredMillion(totalFW2024)}<br><span style="font-size: 0.8em; color: #666;">(100.0%)</span>`;
                totalRow.insertCell(3).innerHTML = `${formatToHundredMillion(totalFW2023)}<br><span style="font-size: 0.8em; color: #666;">(100.0%)</span>`;
                
                const totalGrowthCell = totalRow.insertCell(4);
                const totalGrowthText = totalGrowth >= 0 ? `+${totalGrowth.toFixed(1)}%` : `${totalGrowth.toFixed(1)}%`;
                totalGrowthCell.innerHTML = `<span style="color: ${totalGrowth >= 0 ? '#0066cc' : '#cc0000'}; font-weight: bold; font-size: 1.1em;">${totalGrowthText}</span>`;
            }
        }

        function updateTables() {
            // 아울렛 매출 흐름 테이블은 항상 전체 데이터로 고정
            updateDistributorTable();
        }

        function updateSummaryTable(distributorData) {
            const tbody = document.querySelector('#summaryTable tbody');
            const thead = document.querySelector('#summaryTableHead tr');
            tbody.innerHTML = '';

            // 선택된 시즌 타입 확인
            const selectedSeason = document.querySelector('input[name="seasonType"]:checked').value;
            
            // 헤더 업데이트
            if (selectedSeason === 'SS') {
                thead.innerHTML = `
                    <th>유통사</th>
                    <th>매장수</th>
                    <th>25SS 총매출(구성비)</th>
                    <th>24SS 총매출(구성비)</th>
                    <th>SS 총매출 전년비</th>
                    <th>25SS 평균매출(구성비)</th>
                    <th>24SS 평균매출(구성비)</th>
                    <th>SS 평균매출 전년비</th>
                `;
            } else {
                thead.innerHTML = `
                    <th>유통사</th>
                    <th>매장수</th>
                    <th>24FW 총매출(구성비)</th>
                    <th>23FW 총매출(구성비)</th>
                    <th>FW 총매출 전년비</th>
                    <th>24FW 평균매출(구성비)</th>
                    <th>23FW 평균매출(구성비)</th>
                    <th>FW 평균매출 전년비</th>
                `;
            }

            // 전체 총매출과 평균매출 계산 (구성비용)
            let totalSalesSum = 0;
            let totalAvgSum = 0;
            
            Object.entries(distributorData).forEach(([distributor, data]) => {
                if (selectedSeason === 'SS') {
                    totalSalesSum += data.ss2025;
                    totalAvgSum += data.avgSS2025;
                } else {
                    totalSalesSum += data.fw2024;
                    totalAvgSum += data.avgFW2024;
                }
            });

            // 각 유통사별 데이터 표시
            Object.entries(distributorData).forEach(([distributor, data]) => {
                const row = tbody.insertRow();
                
                if (selectedSeason === 'SS') {
                    const salesComposition2025 = ((data.ss2025 / totalSalesSum) * 100).toFixed(1);
                    const salesComposition2024 = ((data.ss2024 / totalSalesSum) * 100).toFixed(1);
                    const avgComposition2025 = ((data.avgSS2025 / totalAvgSum) * 100).toFixed(1);
                    const avgComposition2024 = ((data.avgSS2024 / totalAvgSum) * 100).toFixed(1);
                    const salesGrowth = data.ss2024 !== 0 ? (((data.ss2025 - data.ss2024) / data.ss2024) * 100) : 0;
                    const avgGrowth = data.avgSS2024 !== 0 ? (((data.avgSS2025 - data.avgSS2024) / data.avgSS2024) * 100) : 0;
                    
                    row.insertCell(0).textContent = distributor;
                    row.insertCell(1).textContent = data.storeCount;
                    
                    // 25SS 총매출(구성비)
                    const cell2025 = row.insertCell(2);
                    cell2025.innerHTML = `${formatToHundredMillion(data.ss2025)}<br><span style="font-size: 0.8em; color: #666;">(${salesComposition2025}%)</span>`;
                    
                    // 24SS 총매출(구성비)
                    const cell2024 = row.insertCell(3);
                    cell2024.innerHTML = `${formatToHundredMillion(data.ss2024)}<br><span style="font-size: 0.8em; color: #666;">(${salesComposition2024}%)</span>`;
                    
                    // SS 총매출 전년비 (색상 적용)
                    const salesGrowthCell = row.insertCell(4);
                    const salesGrowthText = salesGrowth >= 0 ? `+${salesGrowth.toFixed(1)}%` : `${salesGrowth.toFixed(1)}%`;
                    salesGrowthCell.innerHTML = `<span style="color: ${salesGrowth >= 0 ? '#0066cc' : '#cc0000'};">${salesGrowthText}</span>`;
                    
                    // 25SS 평균매출(구성비)
                    const avgCell2025 = row.insertCell(5);
                    avgCell2025.innerHTML = `${formatToHundredMillion(data.avgSS2025)}<br><span style="font-size: 0.8em; color: #666;">(${avgComposition2025}%)</span>`;
                    
                    // 24SS 평균매출(구성비)
                    const avgCell2024 = row.insertCell(6);
                    avgCell2024.innerHTML = `${formatToHundredMillion(data.avgSS2024)}<br><span style="font-size: 0.8em; color: #666;">(${avgComposition2024}%)</span>`;
                    
                    // SS 평균매출 전년비 (색상 적용)
                    const avgGrowthCell = row.insertCell(7);
                    const avgGrowthText = avgGrowth >= 0 ? `+${avgGrowth.toFixed(1)}%` : `${avgGrowth.toFixed(1)}%`;
                    avgGrowthCell.innerHTML = `<span style="color: ${avgGrowth >= 0 ? '#0066cc' : '#cc0000'};">${avgGrowthText}</span>`;
                } else {
                    const salesComposition2024 = ((data.fw2024 / totalSalesSum) * 100).toFixed(1);
                    const salesComposition2023 = ((data.fw2023 / totalSalesSum) * 100).toFixed(1);
                    const avgComposition2024 = ((data.avgFW2024 / totalAvgSum) * 100).toFixed(1);
                    const avgComposition2023 = ((data.avgFW2023 / totalAvgSum) * 100).toFixed(1);
                    const salesGrowth = data.fw2023 !== 0 ? (((data.fw2024 - data.fw2023) / data.fw2023) * 100) : 0;
                    const avgGrowth = data.avgFW2023 !== 0 ? (((data.avgFW2024 - data.avgFW2023) / data.avgFW2023) * 100) : 0;
                    
                    row.insertCell(0).textContent = distributor;
                    row.insertCell(1).textContent = data.storeCount;
                    
                    // 24FW 총매출(구성비)
                    const cell2024 = row.insertCell(2);
                    cell2024.innerHTML = `${formatToHundredMillion(data.fw2024)}<br><span style="font-size: 0.8em; color: #666;">(${salesComposition2024}%)</span>`;
                    
                    // 23FW 총매출(구성비)
                    const cell2023 = row.insertCell(3);
                    cell2023.innerHTML = `${formatToHundredMillion(data.fw2023)}<br><span style="font-size: 0.8em; color: #666;">(${salesComposition2023}%)</span>`;
                    
                    // FW 총매출 전년비 (색상 적용)
                    const salesGrowthCell = row.insertCell(4);
                    const salesGrowthText = salesGrowth >= 0 ? `+${salesGrowth.toFixed(1)}%` : `${salesGrowth.toFixed(1)}%`;
                    salesGrowthCell.innerHTML = `<span style="color: ${salesGrowth >= 0 ? '#0066cc' : '#cc0000'};">${salesGrowthText}</span>`;
                    
                    // 24FW 평균매출(구성비)
                    const avgCell2024 = row.insertCell(5);
                    avgCell2024.innerHTML = `${formatToHundredMillion(data.avgFW2024)}<br><span style="font-size: 0.8em; color: #666;">(${avgComposition2024}%)</span>`;
                    
                    // 23FW 평균매출(구성비)
                    const avgCell2023 = row.insertCell(6);
                    avgCell2023.innerHTML = `${formatToHundredMillion(data.avgFW2023)}<br><span style="font-size: 0.8em; color: #666;">(${avgComposition2023}%)</span>`;
                    
                    // FW 평균매출 전년비 (색상 적용)
                    const avgGrowthCell = row.insertCell(7);
                    const avgGrowthText = avgGrowth >= 0 ? `+${avgGrowth.toFixed(1)}%` : `${avgGrowth.toFixed(1)}%`;
                    avgGrowthCell.innerHTML = `<span style="color: ${avgGrowth >= 0 ? '#0066cc' : '#cc0000'};">${avgGrowthText}</span>`;
                }
            });
        }

        function updateDistributorTable() {
            const tbody = document.querySelector('#distributorTable tbody');
            tbody.innerHTML = '';

            // 선택된 데이터 타입 확인
            const selectedDataType = document.querySelector('input[name="distributorDataType"]:checked').value;

            // 아울렛 매출 흐름 테이블은 디스커버리 브랜드만 표시
            const discoveryData = rawData.filter(row => row['브랜드'] === '디스커버리');
            const distributors = [...new Set(discoveryData.map(row => row['유통사']))].filter(Boolean);
            
            distributors.forEach(distributor => {
                const row = tbody.insertRow();
                const distributorRows = discoveryData.filter(row => row['유통사'] === distributor);
                
                // 매장 수 계산
                const storeCount = [...new Set(distributorRows.map(row => row['매장명']))].length;
                
                row.insertCell(0).textContent = distributor;
                row.insertCell(1).textContent = storeCount;
                
                if (selectedDataType === 'total') {
                    // 총 매출
                    const ss2025 = distributorRows.reduce((sum, row) => sum + (parseInt(row['25SS']) || 0), 0);
                    const ss2024 = distributorRows.reduce((sum, row) => sum + (parseInt(row['24SS']) || 0), 0);
                    const fw2024 = distributorRows.reduce((sum, row) => sum + (parseInt(row['24FW']) || 0), 0);
                    const fw2023 = distributorRows.reduce((sum, row) => sum + (parseInt(row['23FW']) || 0), 0);
                    
                    const ssGrowth = ss2024 !== 0 ? (((ss2025 - ss2024) / ss2024) * 100) : 0;
                    const fwGrowth = fw2023 !== 0 ? (((fw2024 - fw2023) / fw2023) * 100) : 0;
                    
                    row.insertCell(2).textContent = formatToHundredMillion(ss2025);
                    row.insertCell(3).textContent = formatToHundredMillion(ss2024);
                    
                    const ssGrowthCell = row.insertCell(4);
                    const ssGrowthText = ssGrowth >= 0 ? `+${ssGrowth.toFixed(1)}%` : `${ssGrowth.toFixed(1)}%`;
                    ssGrowthCell.innerHTML = `<span style="color: ${ssGrowth >= 0 ? '#0066cc' : '#cc0000'};">${ssGrowthText}</span>`;
                    
                    row.insertCell(5).textContent = formatToHundredMillion(fw2024);
                    row.insertCell(6).textContent = formatToHundredMillion(fw2023);
                    
                    const fwGrowthCell = row.insertCell(7);
                    const fwGrowthText = fwGrowth >= 0 ? `+${fwGrowth.toFixed(1)}%` : `${fwGrowth.toFixed(1)}%`;
                    fwGrowthCell.innerHTML = `<span style="color: ${fwGrowth >= 0 ? '#0066cc' : '#cc0000'};">${fwGrowthText}</span>`;
                } else {
                    // 평균 매출
                    const ss2025 = distributorRows.reduce((sum, row) => sum + (parseInt(row['25SS']) || 0), 0) / storeCount;
                    const ss2024 = distributorRows.reduce((sum, row) => sum + (parseInt(row['24SS']) || 0), 0) / storeCount;
                    const fw2024 = distributorRows.reduce((sum, row) => sum + (parseInt(row['24FW']) || 0), 0) / storeCount;
                    const fw2023 = distributorRows.reduce((sum, row) => sum + (parseInt(row['23FW']) || 0), 0) / storeCount;
                    
                    const ssGrowth = ss2024 !== 0 ? (((ss2025 - ss2024) / ss2024) * 100) : 0;
                    const fwGrowth = fw2023 !== 0 ? (((fw2024 - fw2023) / fw2023) * 100) : 0;
                    
                    row.insertCell(2).textContent = formatToHundredMillion(ss2025);
                    row.insertCell(3).textContent = formatToHundredMillion(ss2024);
                    
                    const ssGrowthCell = row.insertCell(4);
                    const ssGrowthText = ssGrowth >= 0 ? `+${ssGrowth.toFixed(1)}%` : `${ssGrowth.toFixed(1)}%`;
                    ssGrowthCell.innerHTML = `<span style="color: ${ssGrowth >= 0 ? '#0066cc' : '#cc0000'};">${ssGrowthText}</span>`;
                    
                    row.insertCell(5).textContent = formatToHundredMillion(fw2024);
                    row.insertCell(6).textContent = formatToHundredMillion(fw2023);
                    
                    const fwGrowthCell = row.insertCell(7);
                    const fwGrowthText = fwGrowth >= 0 ? `+${fwGrowth.toFixed(1)}%` : `${fwGrowth.toFixed(1)}%`;
                    fwGrowthCell.innerHTML = `<span style="color: ${fwGrowth >= 0 ? '#0066cc' : '#cc0000'};">${fwGrowthText}</span>`;
                }
            });
        }



        // 페이지 전환 함수
        function showPage(pageId) {
            // 모든 페이지 숨기기
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // 모든 탭 버튼 비활성화
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // 선택된 페이지 보이기
            document.getElementById(pageId).classList.add('active');
            
            // 선택된 탭 버튼 활성화
            event.target.classList.add('active');
            
            // 매장 효율 페이지가 선택되면 차트 로드
            if (pageId === 'storeEfficiencyPage') {
                loadStoreEfficiencyCharts();
            }
        }

        // 페이지 로드 시 자동으로 데이터 로드
        document.addEventListener('DOMContentLoaded', function() {
            // 자동으로 데이터 로드
            updateLoadStatus('🔄 데이터 로드 중...', 'loading');
            loadData();
            
            // 버튼 클릭 시에도 수동으로 로드 가능
            document.getElementById('loadDataBtn').addEventListener('click', function() {
                updateLoadStatus('🔄 데이터 로드 중...', 'loading');
                loadData();
            });
            
            // 시즌 타입 라디오 버튼 이벤트 리스너
            document.querySelectorAll('input[name="seasonType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (rawData.length > 0) {
                        updateDistributorCharts();
                    }
                });
            });
            
            // 유통사별 데이터 타입 라디오 버튼 이벤트 리스너
            document.querySelectorAll('input[name="distributorDataType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (rawData.length > 0) {
                        updateDistributorCharts();
                        updateDistributorTable();
                    }
                });
            });
            
            // SS 차트 데이터 타입 라디오 버튼 이벤트 리스너
            document.querySelectorAll('input[name="ssChartDataType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (rawData.length > 0) {
                        updateDistributorCharts();
                    }
                });
            });
            
            // FW 차트 데이터 타입 라디오 버튼 이벤트 리스너
            document.querySelectorAll('input[name="fwChartDataType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (rawData.length > 0) {
                        updateDistributorCharts();
                    }
                });
            });

            // MS 시즌 선택 라디오 버튼 이벤트 리스너
            document.querySelectorAll('input[name="msSeasonType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (rawData.length > 0) {
                        updateMSCharts();
                    }
                });
            });
        });

        // 매장 효율 차트 로드 함수
        function loadStoreEfficiencyCharts() {
            try {
                if (rawData.length === 0) {
                    document.getElementById('efficiencyRankingTable').innerHTML = 
                        '<p style="text-align: center; color: #cc0000; padding: 20px;">먼저 CSV 파일을 로드해주세요.</p>';
                    return;
                }

                // CSV 데이터에서 효율성 데이터 생성
                const efficiencyData = generateEfficiencyData(rawData);
                const seasons = ['23SS', '23FW', '24SS', '24FW', '25SS'];
                
                // 1. 효율성 순위 표
                createEfficiencyRankingTable(efficiencyData);
                
                // 2. 효율성 히트맵 차트
                createEfficiencyHeatmapChart(efficiencyData, seasons);
                
                // 3. 매장면적 vs 효율성 산점도
                createAreaVsEfficiencyChart(efficiencyData);
                
                // 4. 시즌별 매출액 트렌드 차트
                createSeasonalTrendChart(efficiencyData, seasons);
                
            } catch (error) {
                console.error('매장 효율 데이터 로드 중 오류:', error);
                document.getElementById('efficiencyRankingTable').innerHTML = 
                    '<p style="text-align: center; color: #cc0000; padding: 20px;">데이터 로드 중 오류가 발생했습니다: ' + error.message + '</p>';
            }
        }

        // CSV 데이터에서 효율성 데이터 생성 (디스커버리 브랜드만)
        function generateEfficiencyData(data) {
            const storeData = {};
            
            // 디스커버리 브랜드만 필터링
            const discoveryData = data.filter(row => row['브랜드'] === '디스커버리');
            
            // 매장별 데이터 집계
            discoveryData.forEach(row => {
                const storeName = row['매장명'];
                const distributor = row['유통사'];
                const area = parseFloat(row['매장 면적']) || 0; // J열의 '매장 면적' 컬럼 사용
                const areaPyeong = area / 3.3058; // 평방미터를 평으로 변환
                
                if (!storeData[storeName]) {
                    storeData[storeName] = {
                        매장명: storeName,
                        유통사: distributor,
                        매장면적: area,
                        매장면적_평: areaPyeong,
                        '23SS_매출액': 0,
                        '23FW_매출액': 0,
                        '24SS_매출액': 0,
                        '24FW_매출액': 0,
                        '25SS_매출액': 0,
                        '23SS_효율성': 0,
                        '23FW_효율성': 0,
                        '24SS_효율성': 0,
                        '24FW_효율성': 0,
                        '25SS_효율성': 0,
                        평균효율성: 0
                    };
                }
                
                // 시즌별 매출액 누적
                const seasons = ['23SS', '23FW', '24SS', '24FW', '25SS'];
                seasons.forEach(season => {
                    const sales = parseInt(row[season]) || 0;
                    storeData[storeName][`${season}_매출액`] += sales;
                });
            });
            
            // 효율성 계산 및 정렬
            const efficiencyArray = Object.values(storeData).map(store => {
                const seasons = ['23SS', '23FW', '24SS', '24FW', '25SS'];
                let totalEfficiency = 0;
                let validSeasons = 0;
                
                seasons.forEach(season => {
                    const sales = store[`${season}_매출액`];
                    const efficiency = store.매장면적_평 > 0 ? sales / store.매장면적_평 : 0;
                    store[`${season}_효율성`] = efficiency;
                    
                    if (efficiency > 0) {
                        totalEfficiency += efficiency;
                        validSeasons++;
                    }
                });
                
                store.평균효율성 = validSeasons > 0 ? totalEfficiency / validSeasons : 0;
                return store;
            });
            
            // 평균 효율성 기준으로 내림차순 정렬
            return efficiencyArray.sort((a, b) => b.평균효율성 - a.평균효율성);
        }

        // 효율성 순위 표 생성
        function createEfficiencyRankingTable(data) {
            const tableContainer = document.getElementById('efficiencyRankingTable');
            
            // 표 HTML 생성
            let tableHTML = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <th style="padding: 15px; text-align: center; border: none;">순위</th>
                                <th style="padding: 15px; text-align: left; border: none;">매장명</th>
                                <th style="padding: 15px; text-align: center; border: none;">유통사</th>
                                <th style="padding: 15px; text-align: center; border: none;">매장면적(㎡)</th>
                                <th style="padding: 15px; text-align: center; border: none;">매장면적(평)</th>
                                <th style="padding: 15px; text-align: center; border: none;">평균 효율성</th>
                                <th style="padding: 15px; text-align: center; border: none;">23SS 효율성</th>
                                <th style="padding: 15px; text-align: center; border: none;">23FW 효율성</th>
                                <th style="padding: 15px; text-align: center; border: none;">24SS 효율성</th>
                                <th style="padding: 15px; text-align: center; border: none;">24FW 효율성</th>
                                <th style="padding: 15px; text-align: center; border: none;">25SS 효율성</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // 데이터 행 생성
            data.forEach((store, index) => {
                const rank = index + 1;
                const rankColor = rank <= 3 ? '#ffd700' : rank <= 10 ? '#c0c0c0' : '#cd7f32';
                
                tableHTML += `
                    <tr style="border-bottom: 1px solid #eee; transition: background-color 0.3s;" 
                        onmouseover="this.style.backgroundColor='#f8f9fa'" 
                        onmouseout="this.style.backgroundColor='white'">
                        <td style="padding: 12px; text-align: center; border: none;">
                            <span style="display: inline-block; width: 25px; height: 25px; background: ${rankColor}; color: white; border-radius: 50%; line-height: 25px; font-weight: bold;">${rank}</span>
                        </td>
                        <td style="padding: 12px; text-align: left; border: none; font-weight: 500;">${store.매장명}</td>
                        <td style="padding: 12px; text-align: center; border: none;">${store.유통사}</td>
                        <td style="padding: 12px; text-align: center; border: none;">${store.매장면적.toFixed(1)}</td>
                        <td style="padding: 12px; text-align: center; border: none;">${store.매장면적_평.toFixed(1)}</td>
                        <td style="padding: 12px; text-align: center; border: none; font-weight: bold; color: #2c3e50;">${Math.round(store.평균효율성).toLocaleString()}원/평</td>
                        <td style="padding: 12px; text-align: center; border: none;">${Math.round(store['23SS_효율성']).toLocaleString()}원/평</td>
                        <td style="padding: 12px; text-align: center; border: none;">${Math.round(store['23FW_효율성']).toLocaleString()}원/평</td>
                        <td style="padding: 12px; text-align: center; border: none;">${Math.round(store['24SS_효율성']).toLocaleString()}원/평</td>
                        <td style="padding: 12px; text-align: center; border: none;">${Math.round(store['24FW_효율성']).toLocaleString()}원/평</td>
                        <td style="padding: 12px; text-align: center; border: none;">${Math.round(store['25SS_효율성']).toLocaleString()}원/평</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                    <p style="margin: 0; color: #666; font-size: 14px;">
                        <strong>📊 분석 기준:</strong> 평당 매출액 = 디스커버리 총 매출액 ÷ 매장면적(평)<br>
                        <strong>🏆 순위 기준:</strong> 평균 효율성 (23SS~25SS 시즌 평균) 높은 순<br>
                        <strong>📈 효율성:</strong> 매장 면적 대비 디스커버리 매출액으로 공간 활용 효율성 측정<br>
                        <strong>🎯 대상:</strong> 디스커버리 브랜드 매장만 분석
                    </p>
                </div>
            `;
            
            tableContainer.innerHTML = tableHTML;
        }

        // 효율성 히트맵 차트 생성
        function createEfficiencyHeatmapChart(data, seasons) {
            const storeNames = data.map(item => item.매장명);
            const heatmapData = [];
            
            seasons.forEach(season => {
                const seasonData = data.map(item => item[`${season}_효율성`]);
                heatmapData.push(seasonData);
            });
            
            const trace = {
                z: heatmapData,
                x: storeNames,
                y: seasons,
                type: 'heatmap',
                colorscale: 'Viridis',
                text: heatmapData.map(row => row.map(val => val.toLocaleString() + '원/평')),
                texttemplate: '%{text}',
                textfont: { size: 8 },
                hovertemplate: '<b>%{y}</b><br>%{x}<br>효율성: %{z:,.0f}원/평<extra></extra>'
            };
            
            const layout = {
                title: '디스커버리 매장 시즌별 효율성 히트맵 (평당 매출액)',
                xaxis: { title: '매장명', tickangle: -45 },
                yaxis: { title: '시즌' },
                height: 500,
                margin: { b: 100 }
            };
            
            Plotly.newPlot('efficiencyHeatmapChart', [trace], layout);
        }

        // 매장면적 vs 효율성 산점도 생성
        function createAreaVsEfficiencyChart(data) {
            const trace = {
                x: data.map(item => item.매장면적_평),
                y: data.map(item => item.평균효율성),
                mode: 'markers+text',
                text: data.map(item => item.매장명),
                textposition: 'top center',
                marker: {
                    size: 12,
                    color: data.map(item => item.평균효율성),
                    colorscale: 'Viridis',
                    showscale: true,
                    colorbar: { title: "평균 효율성 (원/평)" },
                    line: { width: 1, color: 'white' }
                },
                name: '매장',
                hovertemplate: '<b>%{text}</b><br>매장면적: %{x:.1f}평<br>평균 효율성: %{y:,.0f}원/평<extra></extra>'
            };
            
            const layout = {
                title: '디스커버리 매장면적 vs 평균효율성',
                xaxis: { title: '매장면적 (평)' },
                yaxis: { title: '평균 효율성 (원/평)' },
                height: 500,
                hovermode: 'closest'
            };
            
            Plotly.newPlot('areaVsEfficiencyChart', [trace], layout);
        }

        // 시즌별 매출액 트렌드 차트 생성
        function createSeasonalTrendChart(data, seasons) {
            const traces = [];
            const topStores = data.slice(0, 10); // 상위 10개 매장
            
            topStores.forEach(store => {
                const seasonSales = seasons.map(season => store[`${season}_매출액`] / 100000000); // 억원 단위로 변환
                
                traces.push({
                    x: seasons,
                    y: seasonSales,
                    mode: 'lines+markers',
                    name: store.매장명,
                    line: { width: 3 },
                    marker: { size: 8 },
                    hovertemplate: '<b>%{fullData.name}</b><br>%{x}<br>매출액: %{y:.1f}억원<extra></extra>'
                });
            });
            
            const layout = {
                title: '디스커버리 상위 10개 매장의 시즌별 매출액 트렌드',
                xaxis: { title: '시즌' },
                yaxis: { title: '매출액 (억원)' },
                height: 500,
                hovermode: 'closest',
                legend: { orientation: 'v', x: 1.02, y: 1 }
            };
            
            Plotly.newPlot('seasonalTrendChart', traces, layout);
        }
    </script>
</body>
</html>
